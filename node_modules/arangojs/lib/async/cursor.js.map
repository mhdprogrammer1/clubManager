{"version":3,"file":"cursor.js","sourceRoot":"","sources":["../../src/cursor.ts"],"names":[],"mappings":"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","sourcesContent":["import { Connection } from \"./connection\";\nimport { Route } from \"./route\";\n\nexport class ArrayCursor {\n  extra: any;\n  count: number;\n\n  private _connection: Connection;\n  private _api: Route;\n  private _result: any;\n  private _hasMore: boolean;\n  private _id: string;\n  private _host?: number;\n\n  constructor(connection: Connection, body: any, host?: number) {\n    this.extra = body.extra;\n    this._connection = connection;\n    this._api = this._connection.route(\"/_api\");\n    this._result = body.result;\n    this._hasMore = Boolean(body.hasMore);\n    this._id = body.id;\n    this._host = host;\n    this.count = body.count;\n  }\n\n  private async _drain(): Promise<ArrayCursor> {\n    await this._more();\n    if (!this._hasMore) return this;\n    return this._drain();\n  }\n\n  private async _more() {\n    if (!this._hasMore) return;\n    else {\n      const res = await this._api.request({\n        method: \"PUT\",\n        path: `/cursor/${this._id}`,\n        host: this._host\n      });\n      this._result.push(...res.body.result);\n      this._hasMore = res.body.hasMore;\n    }\n  }\n\n  async all() {\n    await this._drain();\n    let result = this._result;\n    this._result = [];\n    return result;\n  }\n\n  async next(): Promise<any | undefined> {\n    while (!this._result.length && this._hasMore) {\n      await this._more();\n    }\n    if (!this._result.length) {\n      return undefined;\n    }\n    return this._result.shift();\n  }\n\n  hasNext() {\n    return Boolean(this._hasMore || this._result.length);\n  }\n\n  async each(\n    fn: (value: any, index: number, self: ArrayCursor) => boolean | void\n  ): Promise<boolean> {\n    let index = 0;\n    while (this._result.length || this._hasMore) {\n      let result;\n      while (this._result.length) {\n        result = fn(this._result.shift(), index, this);\n        index++;\n        if (result === false) return result;\n      }\n      if (this._hasMore) await this._more();\n    }\n    return true;\n  }\n\n  async every(\n    fn: (value: any, index: number, self: ArrayCursor) => boolean\n  ): Promise<boolean> {\n    let index = 0;\n    while (this._result.length || this._hasMore) {\n      let result;\n      while (this._result.length) {\n        result = fn(this._result.shift(), index, this);\n        index++;\n        if (!result) return false;\n      }\n      if (this._hasMore) await this._more();\n    }\n    return true;\n  }\n\n  async some(\n    fn: (value: any, index: number, self: ArrayCursor) => boolean\n  ): Promise<boolean> {\n    let index = 0;\n    while (this._result.length || this._hasMore) {\n      let result;\n      while (this._result.length) {\n        result = fn(this._result.shift(), index, this);\n        index++;\n        if (result) return true;\n      }\n      if (this._hasMore) await this._more();\n    }\n    return false;\n  }\n\n  async map<T>(\n    fn: (value: any, index: number, self: ArrayCursor) => T\n  ): Promise<T[]> {\n    let index = 0;\n    let result: any[] = [];\n    while (this._result.length || this._hasMore) {\n      while (this._result.length) {\n        result.push(fn(this._result.shift(), index, this));\n        index++;\n      }\n      if (this._hasMore) await this._more();\n    }\n    return result;\n  }\n\n  async reduce<T>(\n    fn: (accu: T, value: any, index: number, self: ArrayCursor) => T,\n    accu?: T\n  ): Promise<T | undefined> {\n    let index = 0;\n    if (accu === undefined) {\n      if (!this._result.length && !this._hasMore) {\n        await this._more();\n      }\n      accu = this._result.shift();\n      index += 1;\n    }\n    while (this._result.length || this._hasMore) {\n      while (this._result.length) {\n        accu = fn(accu!, this._result.shift(), index, this);\n        index++;\n      }\n      if (this._hasMore) await this._more();\n    }\n    return accu;\n  }\n}\n"]}